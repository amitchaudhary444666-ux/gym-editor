<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GymCut Pro – Fixed CapCut UI</title>
<style>
body{margin:0;background:#000;color:#fff;font-family:system-ui;overflow:hidden}
.app{display:grid;grid-template-rows:60px 1fr 200px;height:100vh}

/* Top Toolbar */
.toolbar{display:flex;align-items:center;justify-content:space-around;padding:6px;background:#111}
.toolbar button{background:#222;color:#fff;border:none;border-radius:12px;width:40px;height:40px;font-size:18px;display:flex;align-items:center;justify-content:center}

/* Video Preview */
.preview{position:relative;display:flex;justify-content:center;align-items:center;background:#000;margin:4px;flex:1}
.preview video{max-width:95%;border-radius:16px;box-shadow:0 4px 20px rgba(0,255,153,0.3)}
.text{position:absolute;font-size:28px;font-weight:900;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,0.7);transform:scale(1)}
.flash{position:absolute;inset:0;background:#00ff99;opacity:0;pointer-events:none;border-radius:16px}

/* Timeline */
.timeline{background:#111;padding:6px;overflow-x:auto;white-space:nowrap;display:flex;align-items:center;gap:4px;position:relative;height:60px}
.clip{display:inline-block;width:80px;height:40px;background:#222;border-radius:8px;position:absolute}
.beat{display:inline-block;width:2px;height:40px;background:#00ff99;position:absolute}
.key{position:absolute;top:-8px;color:#00ff99;font-size:16px}

/* Bottom Adjustment Panel */
.adjust-panel{position:absolute;bottom:0;left:0;right:0;background:#111;padding:8px;display:flex;overflow-x:auto;gap:10px;box-shadow:0 -4px 20px rgba(0,255,153,0.2);border-top-left-radius:16px;border-top-right-radius:16px}
.adjust-panel div{display:flex;flex-direction:column;align-items:center}
.adjust-panel label{font-size:12px;color:#fff}
.adjust-panel input[type=range]{width:80px}
</style>
</head>
<body>
<div class="app">

<!-- Top Toolbar -->
<div class="toolbar">
<button onclick="uploadVideo()"></button>
<button onclick="uploadAudio()"></button>
<button onclick="undo()"></button>
<button onclick="redo()"></button>
<button onclick="applyPreset('shred')"></button>
<button onclick="detectBeats()"></button>
<button onclick="addKeyframe()"></button>
<button onclick="addText()"></button>
<button onclick="exportVideo()"></button>
<input type="file" id="videoIn" accept="video/*" hidden>
<input type="file" id="audioIn" accept="audio/*" hidden>
</div>

<!-- Preview -->
<div class="preview" id="preview">
<div class="flash" id="flash"></div>
</div>

<!-- Timeline -->
<div class="timeline" id="timeline"></div>

<!-- Adjustment Panel -->
<div class="adjust-panel">
<div><label>Brightness</label><input type="range" id="brightness" min="50" max="150" value="100"></div>
<div><label>Contrast</label><input type="range" id="contrast" min="50" max="200" value="100"></div>
<div><label>Saturation</label><input type="range" id="saturation" min="50" max="200" value="100"></div>
<div><label>Exposure</label><input type="range" id="exposure" min="50" max="150" value="100"></div>
<div><label>Shadows</label><input type="range" id="shadows" min="0" max="100" value="50"></div>
<div><label>Highlights</label><input type="range" id="highlights" min="0" max="100" value="50"></div>
<div><label>Temperature</label><input type="range" id="temperature" min="2000" max="10000" value="5500"></div>
<div><label>Tint</label><input type="range" id="tint" min="-100" max="100" value="0"></div>
<div><label>Vibrance</label><input type="range" id="vibrance" min="50" max="200" value="100"></div>
<div><label>Sharpness</label><input type="range" id="sharpness" min="0" max="100" value="0"></div>
<div><label>Vignette</label><input type="range" id="vignette" min="0" max="100" value="0"></div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.9/dist/ffmpeg.min.js"></script>
<script>
const {createFFmpeg, fetchFile} = FFmpeg;
const ffmpeg = createFFmpeg({log:true});

const videoIn=document.getElementById('videoIn');
const audioIn=document.getElementById('audioIn');
const preview=document.getElementById('preview');
const flash=document.getElementById('flash');
const timeline=document.getElementById('timeline');

const sliders=['brightness','contrast','saturation','exposure','shadows','highlights','temperature','tint','vibrance','sharpness','vignette']
let sliderEls={};
sliders.forEach(id=>sliderEls[id]=document.getElementById(id));

let video,file,audioBuffer,ctx,audioFile;
let beats=[],cuts=[],keyframes=[],textEl;

/* Video & Audio Upload */
function uploadVideo(){videoIn.click();}
function uploadAudio(){audioIn.click();}
videoIn.onchange=e=>{
file=e.target.files[0];
if(video) preview.removeChild(video);
video=document.createElement('video');
video.src=URL.createObjectURL(file);
video.controls=true;
preview.appendChild(video);
video.ontimeupdate=()=>{ runEngine(); animateTextOnBeat(); };
updateFilters();
updateTimeline();
}
audioIn.onchange=async e=>{
ctx=new AudioContext();
audioFile=e.target.files[0];
const arr=await e.target.files[0].arrayBuffer();
audioBuffer=await ctx.decodeAudioData(arr);
}

/* Filter Update */
sliders.forEach(id=>sliderEls[id].oninput=()=>{updateFilters();});
function updateFilters(){
if(!video) return;
video.style.filter=
`brightness(${sliderEls.brightness.value}%) contrast(${sliderEls.contrast.value}%) saturate(${sliderEls.saturation.value}%) 
blur(${sliderEls.sharpness.value/10}px)`; // simplified
}

/* Preset */
function applyPreset(p){
if(!video)return;
if(p==='shred'){
let t=0;
const anim=setInterval(()=>{
sliderEls.brightness.value=95+t*0.2;
sliderEls.contrast.value=130+t;
sliderEls.saturation.value=120+t*0.3;
updateFilters();
t++; if(t>30)clearInterval(anim);
},50);
}
}

/* Text & Keyframes */
function addText(){
if(!textEl){
textEl=document.createElement('div');
textEl.className='text';
textEl.innerText='DAY 90';
preview.appendChild(textEl);
}
}
function addKeyframe(){
if(!video)return;
keyframes.push({time:video.currentTime,scale:1.5});
updateTimeline();
}

/* Beat Detection */
function detectBeats(){
if(!audioBuffer)return alert("Add audio first");
beats=[];cuts=[];
const data=audioBuffer.getChannelData(0);
const step=1024;
for(let i=0;i<data.length;i+=step){
let sum=0;
for(let j=0;j<step;j++) sum+=Math.abs(data[i+j]||0);
if(sum/step>0.3){
const t=i/audioBuffer.sampleRate;
beats.push(t); cuts.push(t);
}
}
updateTimeline();
}

/* Timeline Update (fixed scaling) */
function updateTimeline(){
if(!video) return;
timeline.innerHTML='';
const duration=video.duration || 1;
const width=timeline.offsetWidth || 600;

cuts.forEach(t=>{
const clip=document.createElement('div');
clip.className='clip';
clip.style.left=(t/duration*width)+'px';
timeline.appendChild(clip);
});
beats.forEach(t=>{
const b=document.createElement('div');
b.className='beat';
b.style.left=(t/duration*width)+'px';
timeline.appendChild(b);
});
keyframes.forEach(kf=>{
const k=document.createElement('span');
k.className='key';
k.style.left=(kf.time/duration*width)+'px';
k.innerText='';
timeline.appendChild(k);
});
}

/* Engine & Text Animation on Beat */
function runEngine(){
if(!video) return;
const t=video.currentTime;
if(keyframes.length>1){
for(let i=0;i<keyframes.length-1;i++){
let a=keyframes[i],b=keyframes[i+1];
if(t>=a.time && t<=b.time){
let p=(t-a.time)/(b.time-a.time);
let s=1+p*(b.scale-1);
if(textEl) textEl.style.transform=`scale(${s})`;
}
}
}
}

function animateTextOnBeat(){
if(!video || !textEl) return;
const t=video.currentTime;
beats.forEach(b=>{
if(Math.abs(t-b)<0.04){
flash.style.opacity=0.4;
setTimeout(()=>flash.style.opacity=0,80);
textEl.style.transform='scale(1.6)';
textEl.style.color='#00ff99';
setTimeout(()=>{
textEl.style.transform='scale(1)';
textEl.style.color='#fff';
},120);
}
});
}

/* Export */
async function exportVideo(){
if(!file)return alert("Add video first");
if(!ffmpeg.isLoaded()) await ffmpeg.load();
ffmpeg.FS('writeFile','v.mp4',await fetchFile(file));
if(audioFile) ffmpeg.FS('writeFile','a.mp3',await fetchFile(audioFile));

let filter=`eq=brightness=${sliderEls.brightness.value/100}:contrast=${sliderEls.contrast.value/100}:saturation=${sliderEls.saturation.value/100}`;
if(textEl) filter+=`,drawtext=text='DAY 90':fontcolor=white:fontsize=48:x=(w-text_w)/2:y=(h-text_h)/2:enable='between(t,0,${video.duration})'`;

let args=['-i','v.mp4'];
if(audioFile) args.push('-i','a.mp3','-shortest');
args.push('-vf',filter,'out.mp4');

await ffmpeg.run(...args);
const data=ffmpeg.FS('readFile','out.mp4');
const url=URL.createObjectURL(new Blob([data.buffer],{type:'video/mp4'}));
const a=document.createElement('a'); a.href=url; a.download='gymcut_capcut_ui.mp4'; a.click();
alert('Export complete!');
}

/* Undo/Redo (placeholders) */
function undo(){alert('Undo feature');}
function redo(){alert('Redo feature');}
</script>
</body>
</html>